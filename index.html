<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéæ Dom's Padel Journey</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border: #30363d;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #238636;
            --accent-orange: #f0883e;
            --accent-purple: #a371f7;
            --accent-red: #f85149;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 2rem;
        }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        header { text-align: center; margin-bottom: 2rem; }
        
        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle { color: var(--text-secondary); font-size: 1.1rem; }
        .live-badge { 
            display: inline-block;
            background: var(--accent-green);
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .filters {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 2rem;
        }
        
        .filter-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .filter-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .filter-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
        }
        
        .filter-btn:hover { border-color: var(--accent-blue); }
        .filter-btn.active { background: var(--accent-blue); border-color: var(--accent-blue); }
        
        select.filter-select {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }
        
        .stat-value { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.25rem; }
        .stat-value.blue { color: var(--accent-blue); }
        .stat-value.green { color: var(--accent-green); }
        .stat-value.orange { color: var(--accent-orange); }
        .stat-value.purple { color: var(--accent-purple); }
        .stat-value.red { color: var(--accent-red); }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .chart-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .chart-controls {
            display: flex;
            gap: 0.5rem;
        }
        
        .chart-wrapper { position: relative; height: 400px; }
        
        .zoom-hint {
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-align: center;
            margin-top: 0.5rem;
        }
        
        .venues-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .venue-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .venue-card {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .venue-name { font-weight: 500; }
        .venue-count { color: var(--accent-blue); font-weight: 700; }
        
        footer {
            text-align: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        footer a { color: var(--accent-blue); text-decoration: none; }
        
        .loading {
            text-align: center;
            padding: 4rem;
            color: var(--text-secondary);
        }
        
        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            body { padding: 1rem; }
            h1 { font-size: 1.75rem; }
            .stat-value { font-size: 1.5rem; }
            .chart-wrapper { height: 300px; }
            .filters { flex-direction: column; align-items: stretch; }
            .filter-group { justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéæ Dom's Padel Journey <span class="live-badge">LIVE</span></h1>
            <p class="subtitle">Real-time stats from Playtomic ‚Äî October 2022 to Present</p>
        </header>
        
        <div class="filters">
            <div class="filter-group">
                <span class="filter-label">Period:</span>
                <button class="filter-btn" data-range="30">30d</button>
                <button class="filter-btn" data-range="90">3mo</button>
                <button class="filter-btn" data-range="180">6mo</button>
                <button class="filter-btn" data-range="365">1yr</button>
                <button class="filter-btn active" data-range="all">All</button>
            </div>
            <div class="filter-group">
                <span class="filter-label">Smoothing:</span>
                <button class="filter-btn smooth-btn" data-smooth="1">None</button>
                <button class="filter-btn smooth-btn active" data-smooth="7">7d</button>
                <button class="filter-btn smooth-btn" data-smooth="30">30d</button>
            </div>
            <div class="filter-group">
                <span class="filter-label">Venue:</span>
                <select class="filter-select" id="venueFilter">
                    <option value="all">All Venues</option>
                </select>
            </div>
        </div>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading data from Supabase...</p>
        </div>
        
        <div id="content" style="display: none;">
            <div class="stats-grid" id="statsGrid">
                <!-- Stats populated by JS -->
            </div>
            
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">üìà Level Evolution</h2>
                    <div class="chart-controls">
                        <button class="filter-btn" id="resetZoom">Reset Zoom</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="levelChart"></canvas>
                </div>
                <p class="zoom-hint">üîç Scroll to zoom ‚Ä¢ Drag to pan ‚Ä¢ Double-click to reset</p>
            </div>
            
            <div class="venues-section">
                <h2 class="chart-title">üìç Venues</h2>
                <div class="venue-list" id="venueList">
                    <!-- Venues populated by JS -->
                </div>
            </div>
        </div>
        
        <footer>
            <p>Data synced from <a href="https://playtomic.io" target="_blank">Playtomic</a> via Supabase</p>
            <p>Auto-updates weekly ‚Ä¢ Built with ‚ù§Ô∏è by Fred</p>
        </footer>
    </div>
    
    <script>
        const SUPABASE_URL = 'https://wlcxgdxpzbiqbazfvtsu.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsY3hnZHhwemJpcWJhemZ2dHN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExMTY4NTEsImV4cCI6MjA4NjY5Mjg1MX0.u-8kWxdIDZI_1O9XMT-2-WtgDvB7vlY7Lx3EMIXPHvU';
        
        let allData = [];
        let chart = null;
        let currentRange = 'all';
        let currentSmooth = 7;
        let currentVenue = 'all';
        
        async function fetchData() {
            const response = await fetch(
                `${SUPABASE_URL}/rest/v1/padel_matches?select=match_date,level,venue&order=match_date.asc`,
                {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                }
            );
            return await response.json();
        }
        
        function filterData(data, range, venue) {
            let filtered = [...data];
            
            // Filter by venue
            if (venue !== 'all') {
                filtered = filtered.filter(d => d.venue === venue);
            }
            
            // Filter by date range
            if (range !== 'all') {
                const days = parseInt(range);
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - days);
                filtered = filtered.filter(d => new Date(d.match_date) >= cutoff);
            }
            
            return filtered;
        }
        
        function smoothData(data, window) {
            if (window <= 1) return data;
            
            return data.map((d, i) => {
                const start = Math.max(0, i - Math.floor(window / 2));
                const end = Math.min(data.length, i + Math.ceil(window / 2));
                const slice = data.slice(start, end);
                const avg = slice.reduce((sum, x) => sum + x.level, 0) / slice.length;
                return { ...d, level: avg };
            });
        }
        
        function calculateStats(data) {
            if (data.length === 0) return {};
            
            const levels = data.map(d => d.level);
            const current = levels[levels.length - 1];
            const peak = Math.max(...levels);
            const lowest = Math.min(...levels);
            const first = levels[0];
            const growth = ((current - first) / first * 100).toFixed(1);
            
            return {
                matches: data.length,
                current: current.toFixed(2),
                peak: peak.toFixed(2),
                lowest: lowest.toFixed(2),
                growth: growth
            };
        }
        
        function updateStats(stats) {
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value blue">${stats.matches}</div>
                    <div class="stat-label">Matches</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value green">${stats.current}</div>
                    <div class="stat-label">Current Level</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value purple">${stats.peak}</div>
                    <div class="stat-label">Peak Level</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value red">${stats.lowest}</div>
                    <div class="stat-label">Lowest Level</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value orange">${stats.growth > 0 ? '+' : ''}${stats.growth}%</div>
                    <div class="stat-label">Growth</div>
                </div>
            `;
        }
        
        function updateVenues(data) {
            const venues = {};
            data.forEach(d => {
                venues[d.venue] = (venues[d.venue] || 0) + 1;
            });
            
            const sorted = Object.entries(venues).sort((a, b) => b[1] - a[1]);
            
            // Update venue filter
            const select = document.getElementById('venueFilter');
            select.innerHTML = '<option value="all">All Venues</option>' + 
                sorted.map(([name, count]) => `<option value="${name}">${name} (${count})</option>`).join('');
            select.value = currentVenue;
            
            // Update venue list
            document.getElementById('venueList').innerHTML = sorted.slice(0, 6).map(([name, count]) => `
                <div class="venue-card">
                    <span class="venue-name">${name}</span>
                    <span class="venue-count">${count} matches</span>
                </div>
            `).join('');
        }
        
        function updateChart(data) {
            const smoothed = smoothData(data, currentSmooth);
            
            // Calculate trend
            const xValues = smoothed.map((_, i) => i);
            const yValues = smoothed.map(d => d.level);
            const n = xValues.length;
            if (n < 2) return;
            
            const sumX = xValues.reduce((a, b) => a + b, 0);
            const sumY = yValues.reduce((a, b) => a + b, 0);
            const sumXY = xValues.reduce((acc, x, i) => acc + x * yValues[i], 0);
            const sumXX = xValues.reduce((acc, x) => acc + x * x, 0);
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            const trendData = xValues.map(x => slope * x + intercept);
            
            if (chart) {
                chart.data.labels = smoothed.map(d => d.match_date);
                chart.data.datasets[0].data = smoothed.map(d => d.level);
                chart.data.datasets[1].data = trendData;
                chart.update();
            } else {
                const ctx = document.getElementById('levelChart').getContext('2d');
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(88, 166, 255, 0.3)');
                gradient.addColorStop(1, 'rgba(88, 166, 255, 0)');
                
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: smoothed.map(d => d.match_date),
                        datasets: [
                            {
                                label: 'Level',
                                data: smoothed.map(d => d.level),
                                borderColor: '#58a6ff',
                                backgroundColor: gradient,
                                fill: true,
                                tension: 0.3,
                                pointRadius: currentRange === 'all' ? 1 : 3,
                                pointHoverRadius: 6,
                            },
                            {
                                label: 'Trend',
                                data: trendData,
                                borderColor: '#f0883e',
                                borderDash: [5, 5],
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: false,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { intersect: false, mode: 'index' },
                        plugins: {
                            legend: { labels: { color: '#8b949e' } },
                            tooltip: {
                                backgroundColor: '#161b22',
                                borderColor: '#30363d',
                                borderWidth: 1,
                                titleColor: '#f0f6fc',
                                bodyColor: '#8b949e',
                            },
                            zoom: {
                                zoom: {
                                    wheel: { enabled: true },
                                    pinch: { enabled: true },
                                    mode: 'x',
                                },
                                pan: {
                                    enabled: true,
                                    mode: 'x',
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: { unit: currentRange === 'all' ? 'quarter' : 'week' },
                                grid: { color: 'rgba(48, 54, 61, 0.5)' },
                                ticks: { color: '#8b949e', maxTicksLimit: 10 }
                            },
                            y: {
                                grid: { color: 'rgba(48, 54, 61, 0.5)' },
                                ticks: { color: '#8b949e' }
                            }
                        }
                    }
                });
            }
        }
        
        function refresh() {
            const filtered = filterData(allData, currentRange, currentVenue);
            const stats = calculateStats(filtered);
            updateStats(stats);
            updateChart(filtered);
        }
        
        // Event listeners
        document.querySelectorAll('.filter-btn[data-range]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn[data-range]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentRange = btn.dataset.range;
                refresh();
            });
        });
        
        document.querySelectorAll('.smooth-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.smooth-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentSmooth = parseInt(btn.dataset.smooth);
                refresh();
            });
        });
        
        document.getElementById('venueFilter').addEventListener('change', (e) => {
            currentVenue = e.target.value;
            refresh();
        });
        
        document.getElementById('resetZoom').addEventListener('click', () => {
            if (chart) chart.resetZoom();
        });
        
        // Initialize
        async function init() {
            try {
                allData = await fetchData();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                updateVenues(allData);
                refresh();
            } catch (error) {
                document.getElementById('loading').innerHTML = `
                    <p style="color: var(--accent-red);">Error loading data: ${error.message}</p>
                `;
            }
        }
        
        init();
    </script>
</body>
</html>
